@{
    ViewBag.Title = "Register";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="card-body p-t-0">
    <div class="card b-all shadow-none">
        <div class="card-body">
            <h3 class="card-title m-b-0">AGENDADO DE CITAS</h3>
        </div>
        <div>
            <hr class="m-t-0">
        </div>
        <div class="row">
            <div class="card-body col-md-6">
                <p><b><strong>Consideraciones</strong></b></p>
                <p>1. Salus Laboris no se responsabiliza del registro errado de pacientes o protocolos.</p>
                <p>2. Puede realizar el agendado masico importnado la información de los pacientes desde el archivo excel. El formato puede descargarlo en el enlace MATRIZ DE AGENDADO.</p>
                <p>3. Contamos con 90 cupos diarios de atención, de exeder el límite por favor agendar citas para días posteriores.</p>
                <p>4. Corroborar toda la información antes de ser registrada.</p>
            </div>
            <div class="card-body col-md-6">
                <p><b><strong>Requisitos para citas Programadas</strong></b></p>
                <p>Los pacientes deben:</p>
                <p>1. Traer DNI.</p>
                <p>2. Haber descansado mínimo 10 horas.</p>
                <p>3. No ingerir alimentos durante las últimas 10 horas.</p>
                <p>4. Llegar 15 min antes de la cita.</p>
                <p>5. Traer lentes en caso los utilice.</p>
                <p>6. Reposo auditivo durante las últimas 12 horas.</p>
            </div>
        </div>
        <div>
            <hr class="m-t-0">
        </div>
        <div class="card-body">
            <h4><i class="fa fa-building m-r-10 m-b-10"></i> AGENDA</h4>
            <div class="row">
                <div class="col md-6">
                    <div class="form-group">
                        <input type="hidden" id="txtCompanyId" value="" />
                        <label for="txtIdentificationNumber">RUC Empresa Facturación<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtIdentificationNumberFac" value="" placeholder="Ingresar RUC" min="11" maxlength="11">
                            <span class="input-group-btn">
                                <a class="btn btn-secondary" onclick="searchRuc('txtIdentificationNumberFac','txtCompanyNameFac')"><i class="fa fa-search"></i></a>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtCompanyName">Empresa<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="txtCompanyNameFac" value=" " placeholder="Ingresar Nombre Empresa" readonly>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-group">
                        <input type="hidden" id="txtCompanyId" value="" />
                        <label for="txtIdentificationNumber">RUC Empresa Resultados<span class="text-danger">*</span></label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="txtIdentificationNumberRuc" value="" placeholder="Ingresar RUC" min="11" maxlength="11">
                            <span class="input-group-btn">
                                <a class="btn btn-secondary" onclick="searchRuc('txtIdentificationNumberRuc','txtCompanyNameRuc')"><i class="fa fa-search"></i></a>
                            </span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="txtCompanyName">Empresa<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="txtCompanyNameRuc" value=" " placeholder="Ingresar Nombre Empresa" readonly>
                    </div>
                </div>
            </div>
            <div class="row">
                <button id="btnImportExcel" onclick="ModalImportExcel()" class="btn btn-warning waves-effect waves-light m-2">Importar Excel</button>
            </div>
            <div class="row m-t-100">
                <div class="table-responsive table-headquarter">
                    <table id="mainTable" class="table table-bordered table-striped m-b-0">
                        <thead>
                            <tr>
                                <th>Fecha Programación</th>
                                <th>Tipo Doc</th>
                                <th>Nro. Doc</th>
                                <th>Nombres</th>
                                <th>Apellido Paterno</th>
                                <th>Apellido Materno</th>
                                <th>Género</th>
                                <th>Puesto Actual</th>
                                <th>Celular</th>
                                <th>Email</th>
                                <th>Ex. Adicionales</th>
                                <th class="text-nowrap">Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row" style="text-align:right">
                <button id="btnNewClientUser" onclick="ClearTableSchedule()" class="btn btn-primary waves-effect waves-light m-2">Limpiar</button>
                <button id="btnNewClientUser" onclick="Schedule()" class="btn btn-primary waves-effect waves-light m-2">Agendar</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="UploadModal" tabindex="-1" role="dialog" aria-labelledby="UploadModalLabel1">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="UploadModalLabel1">Importar Agenda</h4>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            </div>
            <div class="modal-body" style="font-size:10px;">
                <form>
                    <div class="fileupload btn btn-danger btn-rounded waves-effect waves-light" style="margin-bottom:20px;">
                        <span><i class="ion-upload"></i>Importar Excel</span>
                        <input type="file" id="archivo" name="archivo" class="upload" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button onclick="ImportExcel()" type="button" class="btn btn-info" >Importar</button>
            </div>
        </div>
    </div>
</div>


@section scripts{
    <script>

        $(document).ready(function () {

        });


        function searchRuc(txtRuc, txtRaz) {
            let ruc = $('#' + txtRuc).val();
            if (ruc.length < 11) {
                swal("RUC debe tener 11 digitos");
            } else {
                SearchCompany(ruc, txtRaz);
            }
        }

        function SearchCompany(ruc, txtRaz) {
            APIController.GetCompanyByRuc(ruc).then((res) => {
                $('#' + txtRaz).val(res.Data.Name);
            });
        }

        function ModalImportExcel() {
            $("#UploadModal").modal("show");
        }

        function ImportExcel() {       
            var data = new FormData();
            data.append("file", document.getElementById("archivo").files[0]);
            $.ajax({
                cache: false,
                dataType: 'json',
                method: 'POST',
                data: data,
                contentType: false,
                processData: false,
                url: '/Schedule/Upload',
                success: function (json) {                    
                    console.log("RESULT", json);
                    renderTableSchedule(json)
                    $("#UploadModal").modal("hide");
                },
                error: function (error) {
                    alerta("Sucedió un error al conectarse al servidor", "rojo");                    
                    console.log(error);
                }
            });
        }

        function renderTableSchedule(data) {
            $("#mainTable tbody").empty;
            let content = "";
            content += "";
            for (var i = 0; i < data.length; i++) {
                ApiSunat();
                content += "<tr>";                
                content += "<td style='width:200px;'><input class='form-control text-center datepick' id='dtp-"+ data[i].DocumentNumber +"'  value='"+ data[i].DateSchedule +"'></td>";
                content += "<td style='width:200px;'>" + data[i].DocumentTypeName + "</td>";             
                content += "<td ><input style='width:200px;' class='form-control text-center' id='txtNroDoc-"+ data[i].DocumentNumber +"'  value='"+ data[i].DocumentNumber +"'></td>";                
                content += "<td style='width:400px;'>" + data[i].FirstName + "</td>";
                content += "<td>" + data[i].FirstLastName + "</td>";
                content += "<td>" + data[i].SecondLastName + "</td>";
                content += "<td>" + data[i].Gender + "</td>";
                content += "<td>" + data[i].CurrentOccupation + "</td>";
                content += "<td>" + data[i].MobileNumber + "</td>";
                content += "<td>" + data[i].Email + "</td>";
                content += "<td >Adicionales</td>";
                content += "<td >Acciones</td>";
                content += "</tr>";
            }

            $("#mainTable tbody").append(content);

             $('.datepick').each(function(){
                $(this).datepicker();
            });
        }

        function ApiSunat() {
            fetch('https://api.reniec.cloud/dni/42708421').then(res => {
                console.log("ApiSunat", res);
            });            
        }
    </script>
}


